/*=======================================================================*\
|| ###################################################################### ||
|| # vBulletin 5.6.0
|| # ------------------------------------------------------------------ # ||
|| # Copyright 2000-2020 MH Sub I, LLC dba vBulletin. All Rights Reserved.  # ||
|| # This file may not be redistributed in whole or significant part.   # ||
|| # ----------------- VBULLETIN IS NOT FREE SOFTWARE ----------------- # ||
|| # http://www.vbulletin.com | http://www.vbulletin.com/license.html   # ||
|| ###################################################################### ||
\*========================================================================*/
window.vBulletin=window.vBulletin||{};window.vBulletin.phrase=window.vBulletin.phrase||{};window.vBulletin.phrase.precache=window.vBulletin.phrase.precache||[];window.vBulletin.phrase.precache=$.merge(window.vBulletin.phrase.precache,["add_tags","edit_tags","error","error_adding_search_tips_code_x","error_adding_tags_code_x","error_fetching_popular_tags","invalid_server_response_please_try_again","invalid_x_tag_length","loading","none","popular_tags_cloud","tag_cloud","unable_to_load_tag_editor","unable_to_save_tags","you_may_add_one_more_tag","you_may_add_x_more_tags","you_may_not_add_any_more_tags",]);window.vBulletin.options=window.vBulletin.options||{};window.vBulletin.options.precache=window.vBulletin.options.precache||[];window.vBulletin.options.precache=$.merge(window.vBulletin.options.precache,["tagforcelower","tagmaxlen","tagminlen"]);window.vBulletin.jsexec=window.vBulletin.jsexec||{};window.vBulletin.jsexec.tag_editor=window.vBulletin.jsexec.tag_editor||{exec:0};window.vBulletin.jsexec.tag_editor.exec++;(function(D){if(window.vBulletin.jsexec.tag_editor.exec>1){return }var A={};vBulletin.tagEditor=vBulletin.tagEditor||{};vBulletin.tagEditor.instance=function(P,W,h,R){var Y=this,a=false,e=false,d=window.vBulletin.options.get("tagmaxlen")||25,J=window.vBulletin.options.get("tagminlen")||3,F=0,O=0,S=false,k=D(P),K=k.closest(".tag-editor-container"),I=k.closest(".tag-editor-wrapper"),Q=K.data("node-id")||0,g=false,N=k.attr("placeholder")?k.attr("placeholder"):"",M=N?N.length:10,j=function(){if(k.length==0){return false}k.attr("maxlength",d);g=new vBulletin_Autocomplete(k,{apiClass:"Tags",containerClass:(h||"")+" entry-field h-clearfix",placeholderText:N,editorContext:{type:"tags",context:Y},minLength:J,beforeAdd:function(m,n){a=e?true:false;if(l()==0){return false}return true},afterAdd:function(m,n){var o=f();if(o==0){k.hide()}k.attr("placeholder","");i(K.find(".tagcloudlink"),K)},afterDelete:function(n,o){a=e?true:false;var p=f();if(W||p>0){k.show();setTimeout(function(){k[0].focus()},10)}k.attr("placeholder",function(){var q=E();return(!q||q.length==0)?N:""});var m=K.find(".tag-cloud .tagcloudlink");if(m.length==0){m=D(".ui-tooltip-popular-tags{0} .tag-cloud .tagcloudlink".format(I.data("tag-editor-class")?"."+I.data("tag-editor-class"):""))}m.each(function(){if(D(this).data("tag")==n){D(this).removeClass("added")}})}});k=g.getInputField();I.data("autocomplete-instance",g)},Z=function(m){if(window.vBulletin.options.get("tagforcelower")==1){m=m.toLowerCase()}if(m.length>d){m=m.substr(0,d)}return m},b=function(p,n){if(!g){return false}if(typeof n=="undefined"||n<1){n=pageData.userid}var m=g.getMinLength();if(p.length<m){vBulletin.warning("error",["invalid_x_tag_length",m]);return false}p=Z(p);var o=g.addElement(p,n);k.val("");f();return o},T=function(o){var m=o.length,n;for(n=0;n<m;++n){b(o[n])}},c=function(m){if(!g){return false}g.clearElements();T(m)},V=function(){k.attr("size",M);var m=JShtmlEncode(D.trim(k.val()));if(m==""){return false}var n="Adding tag: "+m;if(l()>0){setTimeout(function(){b(m)},10);n+=" (Tag added)"}console.log(n)},l=function(){if(W||(F==0&&O==0)){return true}var q=g.countElements(),m=D(g.getElements()).filter(function(r,s){return(pageData.userid==0||s.value==pageData.userid)}).size(),p=F>0?F-q:O-q,o=O==0?p:O-m,n=Math.min(o,p);console.log(["tagCount: "+q,"userTagCount: "+m,"maxTags: "+F,"maxUserTags: "+O,"totalCanAdd: "+p,"userCanAdd: "+o,"canAdd: "+n]);return n},f=function(){var n=K.find(".you-may-add-x-tags"),o=l(),m;if(o===true){return true}else{if(o>1){m=["you_may_add_x_more_tags",o]}else{if(o==1){m="you_may_add_one_more_tag"}else{m="you_may_not_add_any_more_tags";o=0}}}n.toggleClass("warning",(o==0)).html(vBulletin.phrase.get(m));return o},X=function(){g.clearElements()},E=function(){if(!g){return false}return g.getLabels()},H=function(m){if(W){k[0].focus();return }else{if(!A[m]){A[m]={}}else{F=A[m].maxTags;O=A[m].maxUserTags;S=A[m].canManageTags;U();return }}vBulletin.AJAX({call:"/ajax/api/tags/getNodeTags",data:{nodeid:m},success:function(n){if(D.isArray(n.tags)){F=parseInt(n.maxtags,10);O=parseInt(n.maxusertags,10);S=n.canmanagetags;A[m]={maxTags:F,maxUserTags:O,canManageTags:S};U()}},api_error:D.noop,error:D.noop,})};this.addTag=function(n,m){b(n,m)};this.addTags=function(m){T(m)};this.setTags=function(m){c(m)};this.removeAllTags=function(){X()};this.getTags=function(){return E()};this.getTagEditor=function(){return k};if(I.data("initialized")){console.log("Tag Editor is already initialized.");return }else{I.attr("data-initialized",true)}j();k.off("keydown").on("keydown",function(n){var m=D(n.target).val().length;D(n.target).attr("size",(m>M?m:M));if(n.which==13){a=e?true:false;V();n.preventDefault();return false}});k.off("blur").on("blur",function(m){e=window.setTimeout(function(){if(!a){V()}a=false;e=false},0)});k.off("click").on("click",function(m){if(!D(m.target).hasClass("tag-input")){D(".tag-input",D(this)).focus();a=e?true:false}return false});k.each(function(){var m=D(this);m.closest("form").submit(function(){V()})});function U(){var n=K.find(".you-may-add-text");if(!F&&!O){n.addClass("h-hide")}else{var m;if(F&&!O){m=F}else{if(!F&&O){m=O}else{m=Math.min(F,O)}}n.find("span").text(m)}if(!l()){k.hide()}else{if(k.is(":visible")){k[0].focus()}}}D(".tag-cloud-text.inline-tag-cloud .popular-tags-link",K).off("click").on("click",function(){var m=K.find(".tag-cloud");vBulletin.tagEditor.fetchPopularTags({type:"nodes",noformat:1,success:function(n){m.html(n);i(m.find(".tagcloudlink"),K)},error:function(n){m.html('<span class="error">{0}</span>'.format(n))}})});D(".tag-cloud-text:not(.inline-tag-cloud) .popular-tags-link",K).qtip({content:{text:vBulletin.phrase.get("loading")+"...",ajax:{url:vBulletin.getAjaxBaseurl()+"/search/fetchTagCloud",data:({type:"nodes",noformat:1}),type:"POST",dataType:"json",success:function(m,p,o){console.log("/search/fetchTagCloud successful, response: "+JSON.stringify(m));if(m){if(m.errors){this.set("content.text",'<span class="error">{0} {1}</span>'.format(vBulletin.phrase.get("error_fetching_popular_tags"),vBulletin.phrase.get(m.errors[0][0])))}else{this.set("content.text",'<div class="tag-cloud">{0}</div>'.format(m));D(".ui-tooltip-popular-tags").delegate(".tag-cloud .tagcloudlink label","click",G);var n=D(".ui-tooltip-popular-tags{0} .tag-cloud .tagcloudlink".format(I.data("tag-editor-id")?"."+I.data("tag-editor-id"):""));i(n,I)}}else{this.set("content.text",'<span class="error">{0}</span>'.format(vBulletin.phrase.get("error_fetching_popular_tags")))}},error:function(o,n,m){console.log("/search/fetchTagCloud failed, error: "+m);this.set("content.text",'<span class="error">{0}</span>'.format(vBulletin.phrase.get("error_fetching_popular_tags")))}},title:{text:vBulletin.phrase.get("tag_cloud"),button:false}},position:{at:"bottom center",my:"top center",viewport:D(window),effect:false},show:{event:"click",solo:true},hide:"unfocus",style:{classes:"ui-tooltip-shadow ui-tooltip-light ui-tooltip-rounded ui-tooltip-popular-tags "+(I.data("tag-editor-class")||""),width:280},events:{show:function(o,n){var m=D(".ui-tooltip-popular-tags{0} .tag-cloud .tagcloudlink".format(I.data("tag-editor-class")?"."+I.data("tag-editor-class"):""));i(m,I)}}});function G(n){var m=D(this);if(!m.parent().hasClass("added")&&b(m.text())){m.parent().addClass("added");if(k.is(":visible")){k[0].focus()}}return false}function i(m,n){if(m.length>0){var o=(n.find(".tag-input").val()||"").split(",");D.each(o,function(p,q){var r=D.trim(q);m.each(function(){if(D(this).data("tag")==r){D(this).addClass("added")}})})}}function L(n){n.stopPropagation();var m=D(this);var o=I.find(".tag-editor-container");if(o.length==1){o.dialog({title:vBulletin.phrase.get("add_tags"),autoOpen:false,modal:true,resizable:false,closeOnEscape:false,showCloseButton:false,width:500,dialogClass:"dialog-container tag-editor-dialog-container dialog-box",open:function(){X();var p=I.find(".tag-input").val();if(p){var s=p.split(",");for(var r in s){b(D.trim(s[r]))}}else{if(N&&!k.attr("placeholder")){k.attr("placeholder",N)}}var t=f();if(t>0){k.show()}H(m.data("node-id"));var q=D(".tag-cloud",o);vBulletin.tagEditor.fetchPopularTags({type:I.data("type")||"nodes",noformat:1,success:function(u){q.html(u);i(q.find(".tagcloudlink"),I)},error:function(u){q.html('<span class="error">{0}</span>'.format(u))}})},close:function(){var p=I.data("autocomplete-instance");p.close()}}).dialog("open");m.data("tag-dialog",o);o.data("parent",m.closest("form, .search-controls-tags, .form_row"))}else{o=m.data("tag-dialog")||D();o.dialog("open")}return false}K.delegate(".tag-cloud .tagcloudlink label","click",G);I.delegate(".add-tag-link","click",L);if(typeof R!=="undefined"){L.call(R.target,R)}D(document).trigger("vb-tag-editor-init",{"$dialog":K})};vBulletin.tagEditor.fetchPopularTags=function(F){F=F||{};F.type=F.type!="search"?"nodes":F.type;var E=(typeof F.error=="function")?F.error:D.noop;vBulletin.AJAX({call:"/search/fetchTagCloud",data:({type:F.type,noformat:F.noformat}),success:function(G,I,H){if(typeof F.success=="function"){F.success(G,I,H)}},api_error:function(G){E("{0} {1}".format(vBulletin.phrase.get("error_fetching_popular_tags"),vBulletin.phrase.get(G[0])))},error:function(){E(vBulletin.phrase.get("error_fetching_popular_tags"))},})};function C(F,G){var E=G.split(",");G=[];D.each(E,function(I,H){if(H!=""){G.push(H)}});vBulletin.AJAX({call:"/ajax/api/tags/updateUserTags",data:{nodeid:F,taglist:G},success:function(H){if(H){var I=D("#content-tags-"+F);I.find(".js-content-tag, .js-content-tag-none").remove();if(H.tags&&H.tags.length>0){D.each(H.tags,function(K,J){var L=D("<span />").addClass("js-content-tag");D("<a />").attr("href",J.searchurl).html(J.tagtext).appendTo(L);if(K<H.tags.length-1){L.append(document.createTextNode(", "))}L.appendTo(I)})}else{D("<span />").addClass("js-content-tag-none").html(vBulletin.phrase.get("none")).appendTo(I)}}},error_phrase:"unable_to_save_tags",title_phrase:"edit_tags",})}function B(G){var E=D(this),F=E.data("node-id");vBulletin.AJAX({call:"/ajax/render/tag_editor",data:{nodeid:F,dialogOnly:true,editPost:true,editorClass:"js-topic-tag-editor",isAjaxTemplateRenderWithData:true,},success:function(H){D("body").append(H.template);D(document).on("vb-tag-editor-init",function(L,K){var J=K.$dialog;function I(){J.dialog("destroy").closest(".tag-editor-wrapper").remove()}J.on("vb-tag-dialog-cancel",I);J.on("vb-tag-dialog-save",function(N,M){C(F,M.tagList);I()})});new vBulletin.tagEditor.instance(".js-topic-tag-editor",false,false,G)},error_phrase:"unable_to_load_tag_editor",title_phrase:"edit_tags",})}D(document).ready(function(){D(document).off("click",".tag-editor-container .cancel-tag-btn").on("click",".tag-editor-container .cancel-tag-btn",function(){D(".tag-editor-container").dialog("close").trigger("vb-tag-dialog-cancel")});D(document).off("click",".tag-editor-container .save-tag-btn").on("click",".tag-editor-container .save-tag-btn",function(){var H=D(this).closest(".tag-editor-container"),G=H.find(".tag-input").val(),E=G.replace(/\,/g,", "),F=H.data("parent");F.find(".tag-list span").html(E);F.find(".tag-input").val(G);F.find(".tag-list").toggleClass("h-hide",!G);H.dialog("close").trigger("vb-tag-dialog-save",{tagList:G})});D(document).off("mousedown",".tag-editor-container .autocomplete-container").on("mousedown",".tag-editor-container .autocomplete-container",function(){var E=this;setTimeout(function(){var F=D(".autocompleteHelper:visible",E);if(F.length>0){F[0].focus()}},10);return false});if(D(".js-content-entry-tag-editor").length>0&&vBulletin.tagEditor){new vBulletin.tagEditor.instance(".js-content-entry-tag-editor")}D(document).off("click",".js-edit-tags").on("click",".js-edit-tags",B)})})(jQuery);